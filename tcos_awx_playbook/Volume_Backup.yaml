---
# ============================================
# Playbook AWX: Cinder Volume Backup (One-Shot) - MULTI-TENANT
# Eseguito dallo schedule per fare backup automatici
# VERSIONE CON API REST (no openstack.cloud)
# ============================================

- name: Create Cinder Volume Backup
  hosts: localhost
  connection: local
  gather_facts: true
  environment:
    no_proxy: "172.16.17.253,10.1.98.150,10.1.98.74,localhost,127.0.0.1,awx.k8s-prod.tcosmilano.local,awx-prod-service.awx.svc,.local,.svc,.svc.cluster.local"
    NO_PROXY: "172.16.17.253,10.1.98.150,10.1.98.74,localhost,127.0.0.1,awx.k8s-prod.tcosmilano.local,awx-prod-service.awx.svc,.local,.svc,.svc.cluster.local"
  
  tasks:
    # =============================================
    # 1. VALIDAZIONE INPUT
    # =============================================
    
    - name: Validate required variables
      assert:
        that:
          - volume_id is defined and volume_id | length > 0
          - tenant_name is defined and tenant_name | length > 0
          - retention_days is defined
          - openstack_auth_url is defined
          - openstack_username is defined
          - openstack_password is defined
          - (openstack_project_id is defined) or (openstack_project_name is defined)
        fail_msg: "ERROR: Missing required variables"
        success_msg: "‚úì Variables OK - volume_id: {{ volume_id }}, tenant: {{ tenant_name }}"
    
    # =============================================
    # 2. AUTHENTICATE OPENSTACK KEYSTONE (MULTI-TENANT)
    # =============================================
    
    - name: Determine authentication method
      set_fact:
        use_project_id: "{{ openstack_project_id is defined and openstack_project_id != '' }}"

    - name: Log authentication
      debug:
        msg: "üîê Autenticazione OpenStack: {{ 'Project ID (UUID)' if use_project_id else 'Project Name' }} = {{ openstack_project_id if use_project_id else openstack_project_name }}"

    - name: Authenticate with project ID
      uri:
        url: "{{ openstack_auth_url }}/v3/auth/tokens"
        method: POST
        body:
          auth:
            identity:
              methods: [password]
              password:
                user:
                  name: "{{ openstack_username }}"
                  domain:
                    name: "{{ openstack_domain_name | default('Default') }}"
                  password: "{{ openstack_password }}"
            scope:
              project:
                id: "{{ openstack_project_id }}"
        body_format: json
        status_code: 201
        return_content: yes
        validate_certs: no
        timeout: 10
      register: auth_with_id
      when: use_project_id | bool

    - name: Authenticate with project name
      uri:
        url: "{{ openstack_auth_url }}/v3/auth/tokens"
        method: POST
        body:
          auth:
            identity:
              methods: [password]
              password:
                user:
                  name: "{{ openstack_username }}"
                  domain:
                    name: "{{ openstack_domain_name | default('Default') }}"
                  password: "{{ openstack_password }}"
            scope:
              project:
                name: "{{ openstack_project_name }}"
                domain:
                  name: "{{ openstack_domain_name | default('Default') }}"
        body_format: json
        status_code: 201
        return_content: yes
        validate_certs: no
        timeout: 10
      register: auth_with_name
      when: not (use_project_id | bool)

    - name: Set unified auth response
      set_fact:
        auth_response: "{{ auth_with_id if (auth_with_id is defined and not auth_with_id.skipped | default(false)) else auth_with_name }}"

    - name: Extract auth token
      set_fact:
        os_auth_token: "{{ auth_response.x_subject_token }}"

    - name: Log successful authentication
      debug:
        msg: "‚úì Autenticato su OpenStack | Tenant: {{ tenant_name }}"
    
    # =============================================
    # 3. ESTRAI E CORREGGI ENDPOINT CINDER
    # =============================================
    
    - name: Extract Cinder endpoint from service catalog
      set_fact:
        cinder_endpoint_original: "{{ auth_response.json.token.catalog | selectattr('type', 'equalto', 'volumev3') | map(attribute='endpoints') | first | selectattr('interface', 'equalto', 'public') | map(attribute='url') | first }}"
        
    - name: Fix Cinder endpoint to use correct IP
      set_fact:
        cinder_endpoint: "{{ cinder_endpoint_original | regex_replace('172\\.16\\.17\\.253', '10.1.98.150') | regex_replace('https://region-milano\\.linuxwall\\.it', 'https://10.1.98.150') }}"
      
    - name: Log Cinder endpoint
      debug:
        msg: 
          - "Cinder endpoint originale: {{ cinder_endpoint_original }}"
          - "Cinder endpoint corretto: {{ cinder_endpoint }}"
    
    # =============================================
    # 4. VERIFICA ESISTENZA VOLUME (API REST)
    # =============================================
    
    - name: Check if volume exists via Cinder API
      block:
        - name: Get volume info via Cinder API
          uri:
            url: "{{ cinder_endpoint }}/volumes/{{ volume_id }}"
            method: GET
            headers:
              X-Auth-Token: "{{ os_auth_token }}"
              Accept: "application/json"
            validate_certs: no
            status_code: [200, 404]
            timeout: 10
          register: volume_response
        
        - name: Set volume data from API response
          set_fact:
            volume_exists: "{{ volume_response.status == 200 }}"
            volume_name: "{{ volume_response.json.volume.name if volume_response.status == 200 else (backup_name | default('volume_' ~ volume_id[:8])) }}"
        
        - name: Exit if volume doesn't exist
          when: not volume_exists
          block:
            - name: Log missing volume
              debug:
                msg:
                  - "=============================================="
                  - "‚ö†Ô∏è VOLUME NON TROVATO"
                  - "=============================================="
                  - "Volume ID: {{ volume_id }}"
                  - "Tenant: {{ tenant_name }}"
                  - "---"
                  - "Il volume √® stato probabilmente eliminato."
                  - "Il backup schedule dovrebbe essere disabilitato."
                  - "Uscita senza errori per non bloccare lo schedule."
                  - "=============================================="
            
            - name: End playbook successfully (volume doesn't exist)
              meta: end_play
        
        - name: Display success - volume found
          debug:
            msg: "‚úì Volume trovato in OpenStack: {{ volume_name }} ({{ volume_id }})"
          when: volume_exists
      
      rescue:
        - name: Handle Cinder API error
          debug:
            msg: "‚ö†Ô∏è Errore accesso Cinder API - impossibile verificare esistenza volume"
        
        - name: Use fallback volume name
          set_fact:
            volume_name: "{{ backup_name | default('volume_' ~ volume_id[:8]) }}"
            volume_exists: true
    
    # =============================================
    # 5. GENERA NOME BACKUP FINALE
    # Format: anno_mese_giorno_nome_backup_tenant
    # =============================================
    
    - name: Generate date prefix
      set_fact:
        date_prefix: "{{ ansible_date_time.year }}_{{ '%02d' | format(ansible_date_time.month | int) }}_{{ '%02d' | format(ansible_date_time.day | int) }}"
    
    - name: Clean tenant name
      set_fact:
        clean_tenant_name: "{{ tenant_name | regex_replace('[^a-zA-Z0-9_-]', '_') }}"
    
    - name: Check if custom backup_name is provided
      set_fact:
        has_backup_name: "{{ backup_name is defined and backup_name | length > 0 }}"
    
    - name: Use custom backup name if provided
      set_fact:
        clean_backup_name: "{{ backup_name | regex_replace('[^a-zA-Z0-9_-]', '_') }}"
      when: has_backup_name
    
    - name: Generate default backup name from volume if not provided
      set_fact:
        clean_backup_name: "backup_{{ volume_name | regex_replace('[^a-zA-Z0-9_-]', '_') }}"
      when: not has_backup_name
    
    - name: Compose final backup name (date + name + tenant)
      set_fact:
        final_backup_name: "{{ date_prefix }}_{{ clean_backup_name }}_{{ clean_tenant_name }}"
    
    # =============================================
    # 6. DISPLAY INFO
    # =============================================
    
    - name: Display backup info
      debug:
        msg:
          - "=============================================="
          - "INIZIO BACKUP (MULTI-TENANT)"
          - "=============================================="
          - "Volume ID: {{ volume_id }}"
          - "Volume Name: {{ volume_name }}"
          - "Tenant: {{ tenant_name }}"
          - "---"
          - "Nome backup finale: {{ final_backup_name }}"
          - "  - Data: {{ date_prefix }}"
          - "  - Nome: {{ clean_backup_name }}"
          - "  - Tenant: {{ clean_tenant_name }}"
          - "---"
          - "Retention: {{ retention_days }} giorni"
          - "=============================================="
    
    # =============================================
    # 7. CREA BACKUP (API REST)
    # =============================================
    
    - name: Create volume backup via Cinder API
      uri:
        url: "{{ cinder_endpoint }}/backups"
        method: POST
        headers:
          X-Auth-Token: "{{ os_auth_token }}"
          Content-Type: "application/json"
          Accept: "application/json"
        body:
          backup:
            volume_id: "{{ volume_id }}"
            name: "{{ final_backup_name }}"
            description: "Backup automatico daily - Retention {{ retention_days }}gg - Tenant: {{ tenant_name }}"
            force: true
        body_format: json
        validate_certs: no
        status_code: [202]
        timeout: 10
      register: backup_create_response
    
    - name: Extract backup ID
      set_fact:
        backup_id: "{{ backup_create_response.json.backup.id }}"
    
    - name: Display backup creation initiated
      debug:
        msg: "‚è≥ Backup avviato - ID: {{ backup_id }}"
    
    # =============================================
    # 8. ATTENDI COMPLETAMENTO BACKUP
    # =============================================
    
    - name: Wait for backup to complete
      uri:
        url: "{{ cinder_endpoint }}/backups/{{ backup_id }}"
        method: GET
        headers:
          X-Auth-Token: "{{ os_auth_token }}"
          Accept: "application/json"
        validate_certs: no
        status_code: [200]
        timeout: 10
      register: backup_status_response
      until: backup_status_response.json.backup.status in ['available', 'error']
      retries: 60
      delay: 10
    
    - name: Check backup status
      fail:
        msg: "‚ùå Backup failed with status: {{ backup_status_response.json.backup.status }}"
      when: backup_status_response.json.backup.status == 'error'
    
    - name: Display backup creation success
      debug:
        msg: "‚úì Backup creato con successo: {{ final_backup_name }}"
    
    # =============================================
    # 9. GESTIONE RETENTION (API REST)
    # =============================================
    
    - name: Get all backups via Cinder API
      uri:
        url: "{{ cinder_endpoint }}/backups/detail"
        method: GET
        headers:
          X-Auth-Token: "{{ os_auth_token }}"
          Accept: "application/json"
        validate_certs: no
        status_code: [200]
        timeout: 10
      register: all_backups_response
    
    - name: Filter backups for this volume only
      set_fact:
        volume_backups: "{{ all_backups_response.json.backups | selectattr('volume_id', 'equalto', volume_id) | list }}"
    
    - name: Sort backups by creation date (oldest first)
      set_fact:
        sorted_backups: "{{ volume_backups | sort(attribute='created_at') }}"
    
    - name: Calculate retention date (epoch)
      set_fact:
        retention_timestamp: "{{ (ansible_date_time.epoch | int - (retention_days | int * 86400)) }}"
    
    - name: Find old backups to delete
      set_fact:
        old_backups: []
    
    - name: Identify old backups based on retention
      set_fact:
        old_backups: "{{ old_backups + [item] }}"
      loop: "{{ sorted_backups }}"
      when: 
        - item.created_at is defined
        - (item.created_at | to_datetime('%Y-%m-%dT%H:%M:%S.%f')).strftime('%s') | int < retention_timestamp | int
    
    - name: Display retention info
      debug:
        msg:
          - "Backup totali per questo volume: {{ volume_backups | length }}"
          - "Backup da eliminare (retention): {{ old_backups | length }}"
    
    - name: Delete old backups via Cinder API
      uri:
        url: "{{ cinder_endpoint }}/backups/{{ item.id }}"
        method: DELETE
        headers:
          X-Auth-Token: "{{ os_auth_token }}"
        validate_certs: no
        status_code: [202, 404]
        timeout: 10
      loop: "{{ old_backups }}"
      when: old_backups | length > 0
      ignore_errors: true
    
    # =============================================
    # 10. SUMMARY
    # =============================================
    
    - name: Show success message
      debug:
        msg:
          - "=============================================="
          - "‚úì BACKUP COMPLETATO CON SUCCESSO"
          - "=============================================="
          - "Backup Name: {{ final_backup_name }}"
          - "Backup ID: {{ backup_id }}"
          - "Volume: {{ volume_name }} ({{ volume_id }})"
          - "Tenant: {{ tenant_name }}"
          - "Status: {{ backup_status_response.json.backup.status }}"
          - "---"
          - "Backup totali per questo volume: {{ volume_backups | length }}"
          - "Backup eliminati (retention): {{ old_backups | length }}"
          - "Retention policy: {{ retention_days }} giorni"
          - "=============================================="
